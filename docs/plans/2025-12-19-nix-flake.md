# Nix Flake Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add Nix flake support for reproducible builds and development environment

**Architecture:** Standard buildGoModule package with separate devShell containing Go tooling (gopls, delve, staticcheck). Multi-platform support via flake-utils. Bash and nushell shell hooks.

**Tech Stack:** Nix flakes, buildGoModule, Go 1.23, gopls, delve, staticcheck

---

## Task 1: Update .gitignore for Nix Artifacts

**Files:**
- Modify: `.gitignore`

**Step 1: Add Nix-related entries to .gitignore**

Add these lines to `.gitignore`:

```
# Nix
result
result-*
.nix-shell.nu
```

**Rationale:** `result` is the symlink created by `nix build`, `result-*` are named outputs, `.nix-shell.nu` is auto-generated.

**Step 2: Verify changes**

Run: `cat .gitignore`
Expected: New entries appear at the end

**Step 3: Commit**

```bash
git add .gitignore
git commit -m "gitignore: add Nix build artifacts"
```

---

## Task 2: Update go.mod to Go 1.23

**Files:**
- Modify: `go.mod`

**Step 1: Update Go version**

Change line 3 in `go.mod`:

```go
go 1.23
```

**Step 2: Commit**

```bash
git add go.mod
git commit -m "build: update to Go 1.23"
```

**Note:** Dependencies remain unchanged, only the toolchain version updates.

---

## Task 3: Create Initial flake.nix

**Files:**
- Create: `flake.nix`

**Step 1: Write flake.nix with placeholder vendorHash**

Create `flake.nix`:

```nix
{
  description = "A terminal-based process visualization tool";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.${system};
      in
      {
        packages.default = pkgs.buildGoModule {
          pname = "procmap";
          version = "0.1.0";

          src = ./.;

          vendorHash = "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";

          meta = with pkgs.lib; {
            description = "Terminal-based process visualization tool";
            homepage = "https://github.com/req/procmap";
            license = licenses.mit;
            maintainers = [ ];
          };
        };

        devShells.default = pkgs.mkShell {
          buildInputs = with pkgs; [
            go
            gopls
            delve
            go-tools
            staticcheck
          ];

          shellHook = ''
            echo "ðŸš€ procmap development environment"
            echo ""
            echo "Tools available:"
            echo "  go $(go version | cut -d' ' -f3) - Go toolchain"
            echo "  gopls - Language server"
            echo "  delve - Debugger"
            echo "  staticcheck - Linter"
            echo ""
            echo "Quick commands:"
            echo "  go run main.go - Run the app"
            echo "  go test ./... - Run tests"
            echo "  nix build - Build with Nix"
            echo ""

            # Check if running nushell
            if [ -n "$NU_VERSION" ]; then
              echo "ðŸ“ Nushell detected! Run: source .nix-shell.nu"
              echo ""
            fi
          '';
        };
      }
    );
}
```

**Step 2: Verify syntax**

Run: `nix flake check`
Expected: May show warnings but should not error on syntax

**Step 3: Commit**

```bash
git add flake.nix
git commit -m "nix: add initial flake configuration"
```

---

## Task 4: Determine Correct vendorHash

**Files:**
- (No file changes, just running build)

**Step 1: Attempt first build**

Run: `nix build --no-link 2>&1 | tee build.log`

Expected output contains:
```
error: hash mismatch in fixed-output derivation
  specified: sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
       got: sha256-<actual-hash-here>
```

**Step 2: Extract the correct hash**

Run: `grep "got:" build.log | awk '{print $2}'`

Expected: Outputs something like `sha256-abc123xyz...=`

**Step 3: Copy the hash for next task**

Note the hash value - you'll need it in Task 5.

---

## Task 5: Update flake.nix with Correct vendorHash

**Files:**
- Modify: `flake.nix`

**Step 1: Replace placeholder vendorHash**

In `flake.nix`, find line with `vendorHash` and replace with the hash from Task 4:

```nix
vendorHash = "sha256-<paste-actual-hash-here>";
```

**Step 2: Verify build succeeds**

Run: `nix build`
Expected: Build completes successfully, creates `result` symlink

**Step 3: Test the binary**

Run: `./result/bin/procmap --help`
Expected: Binary runs (may show usage or start TUI)

**Step 4: Clean up test result**

Run: `rm result`

**Step 5: Commit**

```bash
git add flake.nix
git commit -m "nix: update vendorHash for Go dependencies"
```

---

## Task 6: Add flake.lock

**Files:**
- Create: `flake.lock` (auto-generated)

**Step 1: Generate lock file**

Run: `nix flake lock`
Expected: Creates `flake.lock` with pinned input versions

**Step 2: Verify lock file**

Run: `cat flake.lock | head -20`
Expected: JSON structure with nixpkgs and flake-utils nodes

**Step 3: Commit**

```bash
git add flake.lock
git commit -m "nix: add flake lock file"
```

---

## Task 7: Create Nushell Environment Script

**Files:**
- Create: `.nix-shell.nu`

**Step 1: Write nushell environment script**

Create `.nix-shell.nu`:

```nu
# Nix development environment for procmap
# This file is auto-generated - do not edit manually

print "ðŸš€ procmap development environment"
print ""
print "Tools available:"
print $"  go (env | where name == PATH | get value | first | path join go | ^which go | lines | first | ^$in version | str trim) - Go toolchain"
print "  gopls - Language server"
print "  delve - Debugger"
print "  staticcheck - Linter"
print ""
print "Quick commands:"
print "  go run main.go - Run the app"
print "  go test ./... - Run tests"
print "  nix build - Build with Nix"
print ""
```

**Step 2: Test in nushell (if available)**

If nushell is available:
```bash
nu -c "source .nix-shell.nu"
```

Expected: Welcome message prints

**Step 3: Add to .gitignore (already done in Task 1)**

Verify `.nix-shell.nu` is in `.gitignore`

**Step 4: Don't commit .nix-shell.nu**

This file should not be committed (it's in .gitignore). It will be recreated by users when they enter the devShell.

---

## Task 8: Test Package Build End-to-End

**Files:**
- (No changes, just verification)

**Step 1: Clean build from scratch**

Run: `nix build --rebuild`
Expected: Builds successfully

**Step 2: Verify binary location**

Run: `ls -l result/bin/`
Expected: Shows `procmap` binary

**Step 3: Test binary execution**

Run: `./result/bin/procmap` (then press 'q' to quit)
Expected: TUI starts and shows process bubbles

**Step 4: Clean up**

Run: `rm result`

---

## Task 9: Test Development Shell

**Files:**
- (No changes, just verification)

**Step 1: Enter development shell**

Run: `nix develop`
Expected: Welcome message appears with tool list

**Step 2: Verify Go is available**

Run: `go version`
Expected: `go version go1.23.x linux/amd64` (or similar)

**Step 3: Verify gopls is available**

Run: `gopls version`
Expected: Version information for gopls

**Step 4: Verify delve is available**

Run: `dlv version`
Expected: Delve debugger version

**Step 5: Verify staticcheck is available**

Run: `staticcheck -version`
Expected: staticcheck version

**Step 6: Build project in devShell**

Run: `go build -o procmap`
Expected: Binary builds successfully

**Step 7: Run the binary**

Run: `./procmap` (then press 'q' to quit)
Expected: Application runs

**Step 8: Clean up and exit**

Run: `rm procmap && exit`

---

## Task 10: Update README with Nix Instructions

**Files:**
- Modify: `README.md`

**Step 1: Add Nix section to README**

After the existing "## Installation" section, add:

```markdown
### With Nix

If you have Nix with flakes enabled:

```bash
# Run directly
nix run github:req/procmap

# Install to profile
nix profile install github:req/procmap

# Build locally
nix build
./result/bin/procmap
```

## Development

### With Nix

Enter the development environment:

```bash
nix develop
```

This provides Go 1.23, gopls, delve, and staticcheck. Then use standard Go commands:

```bash
go run main.go
go test ./...
go build -o procmap
```

### Without Nix
```

**Step 2: Verify formatting**

Run: `cat README.md | grep -A 20 "With Nix"`
Expected: New sections appear correctly formatted

**Step 3: Commit**

```bash
git add README.md
git commit -m "docs: add Nix installation and development instructions"
```

---

## Task 11: Final Verification and Cleanup

**Files:**
- (No changes, final checks)

**Step 1: Verify all files are committed**

Run: `git status`
Expected: `nothing to commit, working tree clean`

**Step 2: Verify flake metadata**

Run: `nix flake metadata`
Expected: Shows procmap flake with description

**Step 3: Verify flake check passes**

Run: `nix flake check`
Expected: All checks pass

**Step 4: Document success**

Run: `echo "âœ… Nix flake implementation complete" > .implementation-complete`

**Step 5: Final commit**

```bash
git add .implementation-complete
git commit -m "chore: mark Nix flake implementation complete"
```

---

## Testing Strategy

After implementation:

1. **Package testing:** `nix build && ./result/bin/procmap`
2. **DevShell testing:** `nix develop -c go build`
3. **Multi-platform:** Test on different systems if available
4. **Clean environment:** `nix build --option sandbox true`

## Success Criteria

- [ ] `nix build` produces working procmap binary
- [ ] `nix develop` provides all development tools
- [ ] `nix flake check` passes
- [ ] README documents Nix usage
- [ ] Both bash and nushell users have working environments
- [ ] All changes committed with clear messages

## Rollback Plan

If issues arise:
```bash
git reset --hard origin/master
git worktree remove .worktrees/nix-flake
git branch -D feature/nix-flake
```
